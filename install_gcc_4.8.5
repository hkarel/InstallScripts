#!/bin/sh

# Для того чтобы не удалять директорию сборки $src_dir после выполнения
# инсталляции необходимо выставить первый параметр сценария не равным 0.
no_remove_dir=${1:-0}

set -u

ver=4.8.5
distrib_dir=$PWD
archive=gcc-${ver}.tar.bz2
src_dir=gcc-${ver}
dest_dir=/opt/gcc/${ver}

# Определение параметров host-системы
if [ ! -e $(dirname $0)/os_detect ]; then
    echo "Error: os_detect script not found."
    exit 1
fi
. $(dirname $0)/os_detect
# ---

MAKE=make
[ "$os_type" = "FreeBSD" ] && MAKE=gmake

SUDO=
if [ "$os_name" = "Ubuntu" ] || [ "$os_name" = "Debian" ]; then
    [ "$(id -u)" -ne 0 ] && SUDO=sudo
else
    if [ "$(id -u)" -ne 0 ]; then
        echo "Error: Script must be running with root privileges"
        exit 1
    fi
fi

if [ "$os_name" = "Ubuntu" ] || [ "$os_name" = "Debian" ]; then
    $SUDO apt-get install -y chrpath binutils

elif [ "$os_name" = "CentOS" ]; then
    yum install -y chrpath binutils
fi


which chrpath > /dev/null 2>&1
if [ "$?" -ne 0 ]; then
    echo "Error: Need install the chrpath utility"
    exit 1
fi

which readelf > /dev/null 2>&1
if [ "$?" -ne 0 ]; then
    echo "Error: Need install the readelf utility"
    exit 1
fi


remove_dir()
{
    cd $distrib_dir
    if [ -d $src_dir ]; then
        echo "Remove directory $src_dir ..."
        rm -rf "$src_dir"
    fi
}

patch_libstdc_plusplus()
{
patch -p0 << 'EOF'
--- libstdc++-v3/configure.orig	2014-04-04 17:53:39.000000000 +0400
+++ libstdc++-v3/configure	2014-09-09 18:39:17.000000000 +0400
@@ -20789,2 +20789,4 @@

+  OPT_LDFLAGS="$OPT_LDFLAGS -Wl,-z,origin -Wl,-rpath,AORIGIN"
+

@@ -27824,2 +27826,4 @@

+  OPT_LDFLAGS="$OPT_LDFLAGS -Wl,-z,origin -Wl,-rpath,AORIGIN"
+

@@ -33755,2 +33759,4 @@

+  OPT_LDFLAGS="$OPT_LDFLAGS -Wl,-z,origin -Wl,-rpath,AORIGIN"
+

@@ -45632,2 +45638,4 @@

+  OPT_LDFLAGS="$OPT_LDFLAGS -Wl,-z,origin -Wl,-rpath,AORIGIN"
+

@@ -45846,2 +45854,4 @@

+  OPT_LDFLAGS="$OPT_LDFLAGS -Wl,-z,origin -Wl,-rpath,AORIGIN"
+

@@ -46321,2 +46331,4 @@

+  OPT_LDFLAGS="$OPT_LDFLAGS -Wl,-z,origin -Wl,-rpath,AORIGIN"
+

@@ -52606,2 +52618,4 @@

+  OPT_LDFLAGS="$OPT_LDFLAGS -Wl,-z,origin -Wl,-rpath,AORIGIN"
+

@@ -58522,2 +58536,4 @@

+  OPT_LDFLAGS="$OPT_LDFLAGS -Wl,-z,origin -Wl,-rpath,AORIGIN"
+

@@ -58689,2 +58705,4 @@

+  OPT_LDFLAGS="$OPT_LDFLAGS -Wl,-z,origin -Wl,-rpath,AORIGIN"
+

@@ -58917,2 +58935,4 @@

+  OPT_LDFLAGS="$OPT_LDFLAGS -Wl,-z,origin -Wl,-rpath,AORIGIN"
+

@@ -64833,2 +64853,4 @@

+  OPT_LDFLAGS="$OPT_LDFLAGS -Wl,-z,origin -Wl,-rpath,AORIGIN"
+

EOF
}

strip_debug_info()
{
    if [ ! -L $1 ]; then
        res=$(file $1 | grep -E 'LSB +shared object|ar archive|LSB +relocatable')
        if [ -n "$res" ]; then
            echo "Stripped: $1"
            $SUDO strip --strip-debug $1
            return
        fi

        res=$(file $1 | grep -E 'LSB +executable')
        if [ -n "$res" ]; then
            echo "Stripped: $1"
            $SUDO strip --strip-all $1
        fi
    fi
}

if [ ! -e $archive ]; then
    url=ftp://ftp.gnu.org/gnu/gcc/gcc-${ver}/${archive}
    wget -c $url
fi

set -e

remove_dir

echo "Extract $archive ..."
tar -xf $archive

cd $src_dir
patch_libstdc_plusplus

./contrib/download_prerequisites
mkdir -p build && cd build

../configure \
    --prefix=${dest_dir} \
    --disable-multilib \
    --enable-languages=c,c++

$MAKE -j4

[ -d $dest_dir ] && $SUDO rm -rf $dest_dir

cd $distrib_dir/$src_dir/build
$SUDO $MAKE install

set +e
echo "Removing debug info ... "
for f in $(find $dest_dir/bin     -type f); do strip_debug_info $f; done
for f in $(find $dest_dir/lib     -type f); do strip_debug_info $f; done
for f in $(find $dest_dir/libexec -type f); do strip_debug_info $f; done
[ -d $dest_dir/lib64 ] && for f in $(find $dest_dir/lib64 -type f); do strip_debug_info $f; done

set -e

echo "Create symlinks ... "
$SUDO ln -sf $dest_dir/bin/g++ /usr/bin/g++-${ver}
$SUDO ln -sf $dest_dir/bin/gcc /usr/bin/gcc-${ver}

echo "Replace AORIGIN on \$ORIGIN ... "
libstdc_file=
[ -e $dest_dir/lib/libstdc++.so.6   ] && libstdc_file=$dest_dir/lib/libstdc++.so.6
[ -e $dest_dir/lib64/libstdc++.so.6 ] && libstdc_file=$dest_dir/lib64/libstdc++.so.6

if [ -n "$libstdc_file" ]; then
    $SUDO chrpath -r '$ORIGIN' $libstdc_file
    # Проверка корректной замены $ORIGIN
    set +e
    res=$(readelf -a $libstdc_file | grep '$ORIGIN')
    if [ -z "$res" ]; then
        echo "Error: Not found \$ORIGIN in $libstdc_file"
        exit 1
    fi
    set -e
fi

# "Отключаем" локализацию сообщений
echo "Set only english messages ... "
[ -d $dest_dir/share/locale ] && $SUDO mv $dest_dir/share/locale $dest_dir/share/locale__

# Проверка путей до библиотек:
echo "Check GCC library path: "
g++-${ver} --print-file-name=libstdc++.a


[ "$no_remove_dir" -eq 0 ] && remove_dir

